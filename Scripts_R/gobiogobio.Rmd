---
title: "gobiogobio"
output: pdf_document
date: "2026-02-03"
---

## Agro Toulouse

## 2A FISA

## Projet UE Conception Numérique

### Traitement des données Naïades sur les goujons

### -------------------------

### R Script edited by Lorys David and Sigala Maélie

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Mise à jour de la console :

```{r}
graphics.off()
rm(list = ls())
```

Chargement des librairies

```{r}
library(dplyr)
library(readr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(stringr)

```

## Importation des données Naïades format csv sur R

Nous avons un dossier zip constitué de 5 fichiers Excel:

-   Conditions environnementales
-   Listes Faune/Flore
-   Opérations
-   Résultats biologiques
-   Stations

Les fichiers qui nous intéressent sont ceux qui répertorient le nombre de poissons par prélèvement (listes Faune/flore) et les données géographiques, les informations des stations (Stations) pour réaliser une cartographie. 
Le fichier "Opérations" nous sera également utile pour obtenir les organismes qui ont organisé les recensements, ainsi que le nom des organismes préleveurs.

```{r}
# Importer les données recensement IPR sur les mêmes périodes
ipr <- read.csv("C:/Users/maeli/Desktop/naiades_ipr/ListesFauneFlore.csv", 
                    header=TRUE, 
                    stringsAsFactors = TRUE, 
                    sep = ';')
View(ipr)

# Regroupons les goujons recensés par date de pêche 

# Regroupons les espèces de goujons ensemble 
taxons_gobio <- c("Gobio", "Gobio gobio", "Gobio occitanae", "Gobio lozanoi")

gobio <- ipr[ipr$NomLatinAppelTaxon %in% taxons_gobio, ]
View(gobio)

# Regrouper par date et compter les occurrences
resultat <- aggregate(gobio$NomLatinAppelTaxon,
                      by = list(Date = gobio$DateDebutOperationPrelBio),
                      FUN = length)

names(resultat)[2] <- "Nombre de goujons"
View(resultat)
```

Combien y'a t'il de goujons prélevés sur 2022 et 2025 toutes stations confondues ?

```{r}
total_gobio = sum(resultat$`Nombre de goujons`, na.rm = TRUE)
total_gobio
```

Réalisons un tableau d'abondance en moyenne par mois sur chaque année :

```{r}
# Regroupement par mois et année
gobio_mensuel <- gobio %>%
  mutate(
    Annee = year(DateDebutOperationPrelBio),
    Mois = month(DateDebutOperationPrelBio, label = TRUE, abbr = FALSE)
  ) %>%
  group_by(Annee, Mois) %>%
  summarise(Nombre_prelevements = n()) %>%
  arrange(Annee, Mois)

gobio_mensuel
```

Regroupons par mois (toutes années confondues) pour analyser s'il y a des tendances saisonnières de présence des goujons :

```{r}
# Vecteur des mois en français pour l'ordre
mois_fr <- c("janvier", "février", "mars", "avril", "mai", "juin",
             "juillet", "août", "septembre", "octobre", "novembre", "décembre")

gobio_mensuel_global <- gobio %>%
  mutate(
    # Conversion explicite en date
    DateDebutOperationPrelBio = as.Date(DateDebutOperationPrelBio),

    # Extraction du mois
    Mois = month(DateDebutOperationPrelBio, label = TRUE, abbr = FALSE)
  ) %>%
  group_by(Mois) %>%
  summarise(Nombre_prelevements = n()) %>%
  arrange(match(Mois, mois_fr))
View(gobio_mensuel_global)
```

Nous pouvons en déduire que les périodes de recensemment se réalise de mai à octobre et qu'il y a une plus forte présence de goujons au mois de septembre (effet post-reproduction)

Combien de y'a t'il de stations de pêche pour le recensement ?

```{r}
ipr %>%
  distinct(LbStationMesureEauxSurface) %>%
  nrow()
```

Combien de prélèvements par an et par stations ?

```{r}
# Conversion de la date + extraction de l'année
ipr <- ipr %>%
  mutate(DateDebutOperationPrelBio = as.Date(DateDebutOperationPrelBio),
         Annee = year(DateDebutOperationPrelBio))

# Comptage par année et par station
prelevements_station_annee <- ipr %>%
  group_by(LbStationMesureEauxSurface, Annee) %>%
  summarise(
    NbPrelevements = n(),
    .groups = "drop"
  )

# Affichage
View(prelevements_station_annee)
```

Moyenne de nb de prélèvements par an et par station :

```{r}
# Calcul du nombre de prélèvements par station et par année
gobio_moyenne_station_annee <- ipr %>%
  mutate(Annee = year(DateDebutOperationPrelBio)) %>%
  group_by(LbStationMesureEauxSurface, Annee) %>%
  summarise(Nombre_prelevements = n()) %>%
  ungroup() %>%
  group_by(LbStationMesureEauxSurface) %>%
  summarise(Moyenne_prelevements_par_an = mean(Nombre_prelevements)) %>%
  arrange(desc(Moyenne_prelevements_par_an))

gobio_moyenne_station_annee
```

Nous pouvons observer un déséquilibre d'opération de prélèvements/an sur les différentes stations. max= 33; min=1

## Vérifier les absences de resencement de goujons par date d'opération de prélèvement ipr par stations :

```{r}
# 1. Toutes les combinaisons Date × Station
dates_stations <- ipr %>%
  distinct(DateDebutOperationPrelBio, LbStationMesureEauxSurface)

# 2. Comptage des Gobio par date × station
gobio_counts <- ipr %>%
  filter(NomLatinAppelTaxon %in% taxons_gobio) %>%
  group_by(DateDebutOperationPrelBio, LbStationMesureEauxSurface) %>%
  summarise(
    nb_gobio = sum(RsTaxRep, na.rm = TRUE),
    .groups = "drop"
  )

# 3. Jointure + complétion des absences
gobio_absences <- dates_stations %>%
  left_join(gobio_counts,
            by = c("DateDebutOperationPrelBio", "LbStationMesureEauxSurface")) %>%
  mutate(
    nb_gobio = replace_na(nb_gobio, 0),
    gobio_present = nb_gobio > 0,
    gobio_absent = !gobio_present
  )
# 4. Ajout des coordonnées géographiques des stations 
cdstations <- read.csv("C:/Users/maeli/Desktop/naiades_ipr/Stations.csv", 
                    header=TRUE, 
                    stringsAsFactors = TRUE, 
                    sep = ';')
View(cdstations)

# Jointure station x nb de gobio par date de prélèvement 
gobio_absences_geo <- gobio_absences %>%
  left_join(cdstations, by = "LbStationMesureEauxSurface")

# Rendre le tableau plus propre en enlevant les colonnes absence/présence (remplacer par des valeurs numériques)
gobio <- gobio_absences_geo %>%
  select(-gobio_absent, -gobio_present)

View(gobio)
# Sauvegarder le fichier CSV
write.csv(gobio, "C:/Users/maeli/Desktop/CNUM/gobio.csv", row.names = FALSE)

```

## Rajouter les infos de la station pour l'atlas provenant des autres fichiers du dossiers Naiades (Opérations)et regrouper par station en prennant en compte toutes les dates de prélèvement dans un format colonne historique.

Par soucis d'exploitation des données, nous reprenons directement le script avec le fichier au format csv.

```{r}
# Importer les données
gobio <- read.csv(
  "C:/Users/maeli/Desktop/CNUM/gobio.csv",
  header = TRUE,
  stringsAsFactors = TRUE,
  sep = ","
)
View(gobio)

# concat valeurs uniques (non-NA) séparées par " | "
concat_unique_bar <- function(x) {
  x <- x[!is.na(x)]
  x <- unique(as.character(x))
  paste(x, collapse = " | ")
}

# colonnes descriptives (tout sauf station/date/nb_gobio)
other_cols <- setdiff(
  names(gobio),
  c("CdStationMesureEauxSurface", "DateDebutOperationPrelBio", "nb_gobio")
)

gobio_station <- gobio %>%
  mutate(
    DateDebutOperationPrelBio = as.character(DateDebutOperationPrelBio),
    nb_gobio_num = suppressWarnings(as.numeric(nb_gobio))
  ) %>%
  group_by(CdStationMesureEauxSurface) %>%
  summarise(
    across(all_of(other_cols), concat_unique_bar),

    nb_prelevements = n(),
    total_gobio     = sum(nb_gobio_num, na.rm = TRUE),

    # historique des dates
    historique_dates = paste(
      DateDebutOperationPrelBio[order(DateDebutOperationPrelBio)],
      collapse = " | "
    ),

    # uniquement les nombres dans l'ordre des dates
    gobio_par_prelevement = paste(
      nb_gobio_num[order(DateDebutOperationPrelBio)],
      collapse = " | "
    ),

    .groups = "drop"
  )

# On réorganisation les colonnes les plus interessantes au début
gobio_station <- gobio_station %>%
  relocate(
    CdStationMesureEauxSurface,
    LbStationMesureEauxSurface,
    CoordXStationMesureEauxSurface,
    CoordYStationMesureEauxSurface,
    nb_prelevements,
    total_gobio,
    historique_dates,
    gobio_par_prelevement
  )

View(gobio_station)

write.csv(gobio_station, "C:/Users/maeli/Desktop/CNUM/gobio.csv", row.names = FALSE)
```

\`\`\`
